---
kind: pipeline
type: kubernetes
name: build-and-publish

steps:
- name: go-build
  image: golang:1.20
  commands:
    - go mod download
    - go install github.com/atomi-ai/atomi/...
  environment:
    GO111MODULE: on
  when:
    event:
      - push

- name: trigger-grocery-tests
  image: drone/cli:1.4.0-alpine
  environment:
    DRONE_SERVER: ${DRONE_SYSTEM_PROTO}://${DRONE_SYSTEM_HOST}
    DRONE_TOKEN:
      from_secret: ATOMI_DRONE_TOKEN
  commands:
    - build_number=$(drone build last atomi-ai/grocery --branch master | grep "Number:" | awk '{print $2}')
    - drone build promote atomi-ai/grocery $build_number production
  depends_on:
    - clone

- name: docker-build-and-publish
  image: plugins/docker
  settings:
    repo: adminatomi/server
    tags:
      - "${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:7}"
    dockerfile: Dockerfile
    username: adminatomi
    password:
      from_secret: DOCKER_PASSWORD
    context: .
  when:
    event:
    - push

